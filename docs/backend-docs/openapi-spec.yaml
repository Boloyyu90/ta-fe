openapi: 3.1.0
info:
  title: Prestige Academy CPNS Exam System API
  description: |
    Backend API for online CPNS tryout system with AI-powered proctoring.

    ## Authentication
    This API uses JWT Bearer token authentication. Include the access token 
    in the Authorization header: `Authorization: Bearer <token>`

    ## Rate Limits
    - Global: 100 requests / 15 minutes
    - Auth: 5 requests / 15 minutes
    - Proctoring: 30 requests / 1 minute

    ## Exam Retake System
    The system supports configurable exam retakes:
    - `allowRetake`: Enable/disable retakes per exam
    - `maxAttempts`: Limit number of attempts (null = unlimited)
    - `attemptNumber`: Track which attempt each session represents

    ## MVP Scope
    This spec documents implemented functionality. The following are **NOT** implemented:
    - Email verification enforcement
    - Password reset flow
    - Time window enforcement at API level (frontend responsibility)
    - WebSocket real-time updates

    ## Critical Integration Notes
    - Always use `examQuestionId` for answer submissions, NOT `questionId`
    - Timer should use server-provided `remainingTimeMs`, not client calculation
    - Proctoring rate limit: max 30 requests/minute (1 every 2 seconds)
  version: 1.0.0
  contact:
    name: I Gede Bala Putra
    email: gede.bala@example.com

servers:
  - url: http://localhost:3000/api/v1
    description: Development server

tags:
  - name: Auth
    description: Authentication endpoints (public)
  - name: Users
    description: User management
  - name: Questions
    description: Question bank management (admin)
  - name: Exams
    description: Exam CRUD operations
  - name: Exam Sessions
    description: Exam taking and submissions
  - name: Proctoring
    description: Proctoring and ML face detection

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # === Enums ===
    UserRole:
      type: string
      enum: [ADMIN, PARTICIPANT]

    ExamStatus:
      type: string
      enum: [IN_PROGRESS, FINISHED, CANCELLED, TIMEOUT]

    QuestionType:
      type: string
      enum: [TIU, TKP, TWK]

    ProctoringEventType:
      type: string
      enum: [FACE_DETECTED, NO_FACE_DETECTED, MULTIPLE_FACES, LOOKING_AWAY]

    AnswerOption:
      type: string
      enum: [A, B, C, D, E]
      nullable: true

    Severity:
      type: string
      enum: [LOW, MEDIUM, HIGH]

    # === Base Entities ===
    User:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
          format: email
        name:
          type: string
        role:
          $ref: "#/components/schemas/UserRole"
        isEmailVerified:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - email
        - name
        - role
        - isEmailVerified
        - createdAt
        - updatedAt

    UserStats:
      type: object
      description: Dashboard statistics for current user
      properties:
        completedExams:
          type: integer
          description: Count of exams with status FINISHED
          minimum: 0
        averageScore:
          type: number
          format: float
          nullable: true
          description: Average totalScore of FINISHED exams, null if none
        totalTimeMinutes:
          type: integer
          description: Total time spent on all FINISHED exams in minutes
          minimum: 0
        activeExams:
          type: integer
          description: Count of exams with status IN_PROGRESS
          minimum: 0
      required:
        - completedExams
        - averageScore
        - totalTimeMinutes
        - activeExams

    TokensData:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
      required:
        - accessToken
        - refreshToken

    QuestionOptions:
      type: object
      properties:
        A:
          type: string
        B:
          type: string
        C:
          type: string
        D:
          type: string
        E:
          type: string
      required: [A, B, C, D, E]

    Question:
      type: object
      properties:
        id:
          type: integer
        content:
          type: string
        options:
          $ref: "#/components/schemas/QuestionOptions"
        correctAnswer:
          type: string
          enum: [A, B, C, D, E]
        questionType:
          $ref: "#/components/schemas/QuestionType"
        defaultScore:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - content
        - options
        - correctAnswer
        - questionType
        - defaultScore
        - createdAt
        - updatedAt

    Exam:
      type: object
      description: Exam entity with retake configuration
      properties:
        id:
          type: integer
        title:
          type: string
        description:
          type: string
          nullable: true
        startTime:
          type: string
          format: date-time
          nullable: true
        endTime:
          type: string
          format: date-time
          nullable: true
        durationMinutes:
          type: integer
        passingScore:
          type: integer
        allowRetake:
          type: boolean
          description: Whether users can retake this exam after completing it
          default: false
        maxAttempts:
          type: integer
          nullable: true
          description: Maximum number of attempts allowed (null = unlimited when retakes enabled)
        createdBy:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - title
        - durationMinutes
        - passingScore
        - allowRetake
        - createdBy
        - createdAt
        - updatedAt

    ExamWithCount:
      allOf:
        - $ref: "#/components/schemas/Exam"
        - type: object
          properties:
            _count:
              type: object
              properties:
                examQuestions:
                  type: integer

    UserExam:
      type: object
      description: Exam session (attempt) for a user
      properties:
        id:
          type: integer
        userId:
          type: integer
        examId:
          type: integer
        attemptNumber:
          type: integer
          description: Which attempt this is (1 = first, 2 = second, etc.)
          minimum: 1
        startedAt:
          type: string
          format: date-time
        submittedAt:
          type: string
          format: date-time
          nullable: true
        totalScore:
          type: integer
          nullable: true
        status:
          $ref: "#/components/schemas/ExamStatus"
      required:
        - id
        - userId
        - examId
        - attemptNumber
        - startedAt
        - status

    ProctoringEvent:
      type: object
      properties:
        id:
          type: integer
        userExamId:
          type: integer
        eventType:
          $ref: "#/components/schemas/ProctoringEventType"
        metadata:
          type: object
          nullable: true
        timestamp:
          type: string
          format: date-time
        severity:
          $ref: "#/components/schemas/Severity"
      required:
        - id
        - userExamId
        - eventType
        - timestamp
        - severity

    # === Pagination ===
    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer
        hasNext:
          type: boolean
        hasPrev:
          type: boolean
      required:
        - page
        - limit
        - total
        - totalPages
        - hasNext
        - hasPrev

    # === API Response Wrappers ===
    ApiSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          type: object
        message:
          type: string
        timestamp:
          type: string
          format: date-time
      required:
        - success
        - timestamp

    ApiErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          enum: [false]
        message:
          type: string
        errorCode:
          type: string
          description: Machine-readable error code
        errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
        context:
          type: object
          description: Additional error context (e.g., maxAttempts, currentAttempts)
        timestamp:
          type: string
          format: date-time
      required:
        - success
        - message
        - timestamp

    # === Auth Responses ===
    AuthPayload:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/User"
        tokens:
          $ref: "#/components/schemas/TokensData"
      required:
        - user
        - tokens

    # === Exam Session Responses ===
    ParticipantQuestion:
      type: object
      description: Question as seen by participant (no correct answer)
      properties:
        id:
          type: integer
          description: Question bank ID (for reference only)
        examQuestionId:
          type: integer
          description: ExamQuestion ID - USE THIS FOR ANSWERS
        content:
          type: string
        options:
          $ref: "#/components/schemas/QuestionOptions"
        questionType:
          $ref: "#/components/schemas/QuestionType"
        orderNumber:
          type: integer
      required:
        - id
        - examQuestionId
        - content
        - options
        - questionType
        - orderNumber

    ParticipantAnswer:
      type: object
      properties:
        examQuestionId:
          type: integer
          description: ExamQuestion ID this answer belongs to
        selectedOption:
          $ref: "#/components/schemas/AnswerOption"
        answeredAt:
          type: string
          format: date-time
          nullable: true
      required:
        - examQuestionId
        - selectedOption

    UserExamSession:
      type: object
      description: Active exam session with attempt tracking
      properties:
        id:
          type: integer
        examId:
          type: integer
        examTitle:
          type: string
        durationMinutes:
          type: integer
        startedAt:
          type: string
          format: date-time
        submittedAt:
          type: string
          format: date-time
          nullable: true
        status:
          $ref: "#/components/schemas/ExamStatus"
        remainingTimeMs:
          type: integer
          description: Remaining time in milliseconds (server-calculated)
        totalQuestions:
          type: integer
        answeredQuestions:
          type: integer
        attemptNumber:
          type: integer
          description: Which attempt this is (1 = first, 2 = second, etc.)
          minimum: 1
      required:
        - id
        - examId
        - examTitle
        - durationMinutes
        - startedAt
        - status
        - remainingTimeMs
        - totalQuestions
        - answeredQuestions
        - attemptNumber

    UserExamListItem:
      type: object
      description: Exam session in list view with attempt information
      properties:
        id:
          type: integer
        exam:
          type: object
          properties:
            id:
              type: integer
            title:
              type: string
            description:
              type: string
              nullable: true
            allowRetake:
              type: boolean
              description: Whether exam allows retakes
            maxAttempts:
              type: integer
              nullable: true
              description: Maximum attempts allowed
          required:
            - id
            - title
            - allowRetake
        status:
          $ref: "#/components/schemas/ExamStatus"
        startedAt:
          type: string
          format: date-time
        submittedAt:
          type: string
          format: date-time
          nullable: true
        totalScore:
          type: integer
          nullable: true
        remainingTimeMs:
          type: integer
          nullable: true
        durationMinutes:
          type: integer
        answeredQuestions:
          type: integer
        totalQuestions:
          type: integer
        attemptNumber:
          type: integer
          minimum: 1
          description: Which attempt this session represents (1, 2, 3...)
      required:
        - id
        - exam
        - status
        - startedAt
        - durationMinutes
        - answeredQuestions
        - totalQuestions
        - attemptNumber

    # === Attach/Detach Questions Responses ===
    AttachQuestionsResponse:
      type: object
      properties:
        attached:
          type: integer
          description: Number of NEW questions attached
        alreadyAttached:
          type: integer
          description: Number of questions that were already attached (skipped)
      required:
        - attached
        - alreadyAttached

    DetachQuestionsResponse:
      type: object
      properties:
        detached:
          type: integer
          description: Number of questions removed
      required:
        - detached

    ScoreByType:
      type: object
      properties:
        type:
          $ref: "#/components/schemas/QuestionType"
        score:
          type: integer
        maxScore:
          type: integer
        correctAnswers:
          type: integer
        totalQuestions:
          type: integer

    ExamResult:
      type: object
      description: Exam result with attempt tracking
      properties:
        id:
          type: integer
        examId:
          type: integer
        examTitle:
          type: string
        userId:
          type: integer
        startedAt:
          type: string
          format: date-time
        submittedAt:
          type: string
          format: date-time
        totalScore:
          type: integer
        status:
          $ref: "#/components/schemas/ExamStatus"
        duration:
          type: integer
          nullable: true
          description: Time taken in seconds
        answeredQuestions:
          type: integer
        totalQuestions:
          type: integer
        attemptNumber:
          type: integer
          description: Which attempt this result is for
          minimum: 1
        scoresByType:
          type: array
          items:
            $ref: "#/components/schemas/ScoreByType"
      required:
        - id
        - examId
        - examTitle
        - userId
        - startedAt
        - submittedAt
        - totalScore
        - status
        - answeredQuestions
        - totalQuestions
        - attemptNumber
        - scoresByType

    # === Face Analysis ===
    FaceAnalysisResult:
      type: object
      properties:
        status:
          type: string
          enum: [success, timeout, error]
        violations:
          type: array
          items:
            type: string
        confidence:
          type: number
          format: float
        message:
          type: string
        metadata:
          type: object
          properties:
            processingTimeMs:
              type: integer
            error:
              type: string

    # === Exam Create/Update DTOs ===
    CreateExamRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 3
          maxLength: 200
        description:
          type: string
          maxLength: 2000
          nullable: true
        startTime:
          type: string
          format: date-time
          nullable: true
        endTime:
          type: string
          format: date-time
          nullable: true
        durationMinutes:
          type: integer
          minimum: 1
          maximum: 300
        passingScore:
          type: integer
          minimum: 0
        allowRetake:
          type: boolean
          default: false
          description: Whether users can retake this exam after completing it
        maxAttempts:
          type: integer
          minimum: 1
          nullable: true
          description: Maximum attempts allowed (only enforced when allowRetake is true)
      required: [title, durationMinutes]

    UpdateExamRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 3
          maxLength: 200
        description:
          type: string
          maxLength: 2000
          nullable: true
        startTime:
          type: string
          format: date-time
          nullable: true
        endTime:
          type: string
          format: date-time
          nullable: true
        durationMinutes:
          type: integer
          minimum: 1
          maximum: 300
        passingScore:
          type: integer
          minimum: 0
        allowRetake:
          type: boolean
          description: Enable/disable retakes for this exam
        maxAttempts:
          type: integer
          minimum: 1
          nullable: true
          description: Set maximum attempts limit

  parameters:
    pageParam:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
    limitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 10
    sortOrderParam:
      name: sortOrder
      in: query
      schema:
        type: string
        enum: [asc, desc]
        default: desc

  responses:
    RetakeDisabledError:
      description: Exam does not allow retakes
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiErrorResponse"
              - type: object
                properties:
                  errorCode:
                    type: string
                    enum: [EXAM_SESSION_RETAKE_DISABLED]

    MaxAttemptsError:
      description: Maximum attempts reached for this exam
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiErrorResponse"
              - type: object
                properties:
                  errorCode:
                    type: string
                    enum: [EXAM_SESSION_MAX_ATTEMPTS]
                  context:
                    type: object
                    properties:
                      maxAttempts:
                        type: integer
                        description: Maximum attempts allowed
                      currentAttempts:
                        type: integer
                        description: Current number of attempts made

paths:
  # === AUTH ENDPOINTS ===
  /auth/register:
    post:
      tags: [Auth]
      summary: Register new user
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                name:
                  type: string
                  minLength: 2
                  maxLength: 100
              required: [email, password, name]
      responses:
        "201":
          description: Registration successful
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/AuthPayload"
        "409":
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiErrorResponse"

  /auth/login:
    post:
      tags: [Auth]
      summary: Login user
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
              required: [email, password]
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/AuthPayload"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiErrorResponse"

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh access token
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refreshToken:
                  type: string
              required: [refreshToken]
      responses:
        "200":
          description: Token refreshed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          tokens:
                            $ref: "#/components/schemas/TokensData"

  /auth/logout:
    post:
      tags: [Auth]
      summary: Logout user
      operationId: logout
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refreshToken:
                  type: string
              required: [refreshToken]
      responses:
        "200":
          description: Logout successful
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          success:
                            type: boolean

  # === USER ENDPOINTS ===
  /me:
    get:
      tags: [Users]
      summary: Get current user profile
      operationId: getMe
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Profile retrieved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          user:
                            $ref: "#/components/schemas/User"
    patch:
      tags: [Users]
      summary: Update current user profile
      operationId: updateMe
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 2
                  maxLength: 100
                password:
                  type: string
                  minLength: 8
      responses:
        "200":
          description: Profile updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          user:
                            $ref: "#/components/schemas/User"

  /me/stats:
    get:
      tags: [Users]
      summary: Get current user's dashboard statistics
      description: |
        Returns aggregated statistics for the authenticated user including:
        - Count of completed exams (status=FINISHED)
        - Average score across all completed exams
        - Total time spent on all completed exams
        - Count of currently active exams (status=IN_PROGRESS)
      operationId: getMyStats
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Statistics retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          stats:
                            $ref: "#/components/schemas/UserStats"
              example:
                success: true
                data:
                  stats:
                    completedExams: 5
                    averageScore: 78.5
                    totalTimeMinutes: 240
                    activeExams: 1
                message: "Statistics retrieved successfully"
                timestamp: "2025-12-30T12:34:56.789Z"
        "401":
          description: Unauthorized - Invalid or missing token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiErrorResponse"

  /admin/users:
    post:
      tags: [Users]
      summary: Create user (admin)
      operationId: createUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                name:
                  type: string
                role:
                  $ref: "#/components/schemas/UserRole"
              required: [email, password, name]
      responses:
        "201":
          description: User created
    get:
      tags: [Users]
      summary: List users (admin)
      operationId: getUsers
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/pageParam"
        - $ref: "#/components/parameters/limitParam"
        - name: role
          in: query
          schema:
            $ref: "#/components/schemas/UserRole"
        - name: search
          in: query
          schema:
            type: string
        - name: sortBy
          in: query
          schema:
            type: string
        - $ref: "#/components/parameters/sortOrderParam"
      responses:
        "200":
          description: Users list

  /admin/users/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Users]
      summary: Get user by ID (admin)
      operationId: getUserById
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User details
    patch:
      tags: [Users]
      summary: Update user (admin)
      operationId: updateUser
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User updated
    delete:
      tags: [Users]
      summary: Delete user (admin)
      operationId: deleteUser
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User deleted

  # === QUESTIONS ENDPOINTS ===
  /admin/questions:
    post:
      tags: [Questions]
      summary: Create question
      operationId: createQuestion
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
                  minLength: 10
                  maxLength: 5000
                options:
                  $ref: "#/components/schemas/QuestionOptions"
                correctAnswer:
                  type: string
                  enum: [A, B, C, D, E]
                questionType:
                  $ref: "#/components/schemas/QuestionType"
                defaultScore:
                  type: integer
                  minimum: 1
                  maximum: 100
              required: [content, options, correctAnswer, questionType]
      responses:
        "201":
          description: Question created
    get:
      tags: [Questions]
      summary: List questions
      operationId: getQuestions
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/pageParam"
        - $ref: "#/components/parameters/limitParam"
        - name: type
          in: query
          schema:
            $ref: "#/components/schemas/QuestionType"
        - name: search
          in: query
          schema:
            type: string
        - name: sortBy
          in: query
          schema:
            type: string
        - $ref: "#/components/parameters/sortOrderParam"
      responses:
        "200":
          description: Questions list

  /admin/questions/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Questions]
      summary: Get question by ID
      operationId: getQuestionById
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Question details
    patch:
      tags: [Questions]
      summary: Update question
      operationId: updateQuestion
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Question updated
    delete:
      tags: [Questions]
      summary: Delete question
      operationId: deleteQuestion
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Question deleted

  # === EXAMS ENDPOINTS ===
  /exams:
    get:
      tags: [Exams]
      summary: List available exams (participant)
      description: |
        Returns exams that have at least 1 question attached.

        **Note:** Time window filtering (startTime/endTime) is NOT enforced at the API level.
        Frontend should handle display logic for exams outside their time window.
      operationId: getAvailableExams
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/pageParam"
        - $ref: "#/components/parameters/limitParam"
        - name: search
          in: query
          schema:
            type: string
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [createdAt, updatedAt, startTime, title]
        - $ref: "#/components/parameters/sortOrderParam"
      responses:
        "200":
          description: Available exams (includes allowRetake and maxAttempts fields)

  /exams/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Exams]
      summary: Get exam details (participant)
      operationId: getExamById
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Exam details with retake configuration

  /exams/{id}/start:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    post:
      tags: [Exam Sessions]
      summary: Start or resume exam
      description: |
        Start a new exam session, resume an existing IN_PROGRESS session, or start a new retake attempt.

        **Behavior:**
        1. If user has an IN_PROGRESS session → Resume that session
        2. If user has completed attempts and retakes disabled → Error (EXAM_SESSION_RETAKE_DISABLED)
        3. If user has completed attempts and max attempts reached → Error (EXAM_SESSION_MAX_ATTEMPTS)
        4. Otherwise → Create new attempt with incremented attemptNumber
      operationId: startExam
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Exam started or resumed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          userExam:
                            $ref: "#/components/schemas/UserExamSession"
                          questions:
                            type: array
                            items:
                              $ref: "#/components/schemas/ParticipantQuestion"
                          answers:
                            type: array
                            items:
                              $ref: "#/components/schemas/ParticipantAnswer"
        "400":
          description: |
            Business rule violation:
            - EXAM_NO_QUESTIONS: Exam has no questions
            - EXAM_NO_DURATION: Duration not set
            - EXAM_SESSION_RETAKE_DISABLED: Retakes not allowed
            - EXAM_SESSION_MAX_ATTEMPTS: Maximum attempts reached
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiErrorResponse"
              examples:
                noQuestions:
                  summary: Exam has no questions
                  value:
                    success: false
                    message: "Exam has no questions"
                    errorCode: "EXAM_NO_QUESTIONS"
                    timestamp: "2025-01-15T10:30:00.000Z"
                noDuration:
                  summary: Duration not set
                  value:
                    success: false
                    message: "Exam duration not configured"
                    errorCode: "EXAM_NO_DURATION"
                    timestamp: "2025-01-15T10:30:00.000Z"
                retakeDisabled:
                  summary: Retakes not allowed
                  value:
                    success: false
                    message: "This exam does not allow retakes"
                    errorCode: "EXAM_SESSION_RETAKE_DISABLED"
                    timestamp: "2025-01-15T10:30:00.000Z"
                maxAttempts:
                  summary: Max attempts reached
                  value:
                    success: false
                    message: "Maximum attempts reached for this exam"
                    errorCode: "EXAM_SESSION_MAX_ATTEMPTS"
                    context:
                      maxAttempts: 3
                      currentAttempts: 3
                    timestamp: "2025-01-15T10:30:00.000Z"
        "404":
          description: Exam not found

  /admin/exams:
    post:
      tags: [Exams]
      summary: Create exam (admin)
      description: Create a new exam with optional retake configuration
      operationId: createExam
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateExamRequest"
            examples:
              basicExam:
                summary: Basic exam (no retakes)
                value:
                  title: "CPNS TIU Practice Test"
                  description: "Practice test for TIU section"
                  durationMinutes: 90
                  passingScore: 70
              retakeableExam:
                summary: Exam with limited retakes
                value:
                  title: "CPNS Full Simulation"
                  description: "Full simulation with 3 attempts"
                  durationMinutes: 180
                  passingScore: 60
                  allowRetake: true
                  maxAttempts: 3
              unlimitedRetakes:
                summary: Exam with unlimited retakes
                value:
                  title: "Practice Quiz"
                  description: "Practice as many times as you want"
                  durationMinutes: 30
                  passingScore: 50
                  allowRetake: true
                  maxAttempts: null
      responses:
        "201":
          description: Exam created
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          exam:
                            $ref: "#/components/schemas/Exam"
    get:
      tags: [Exams]
      summary: List all exams (admin)
      operationId: getExams
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Exams list (includes allowRetake and maxAttempts)

  /admin/exams/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Exams]
      summary: Get exam details (admin)
      operationId: getExamByIdAdmin
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Exam details with retake configuration
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          exam:
                            allOf:
                              - $ref: "#/components/schemas/Exam"
                              - type: object
                                properties:
                                  creator:
                                    type: object
                                    properties:
                                      id:
                                        type: integer
                                      name:
                                        type: string
                                      email:
                                        type: string
                                  _count:
                                    type: object
                                    properties:
                                      examQuestions:
                                        type: integer
                                      userExams:
                                        type: integer
    patch:
      tags: [Exams]
      summary: Update exam (admin)
      description: |
        Update exam settings including retake configuration.

        **Business Rules:**
        - Changing `allowRetake` to `false` does not affect existing attempts
        - Reducing `maxAttempts` does not retroactively invalidate existing attempts
      operationId: updateExam
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateExamRequest"
            examples:
              enableRetakes:
                summary: Enable retakes with limit
                value:
                  allowRetake: true
                  maxAttempts: 3
              disableRetakes:
                summary: Disable retakes
                value:
                  allowRetake: false
      responses:
        "200":
          description: Exam updated
    delete:
      tags: [Exams]
      summary: Delete exam (admin)
      operationId: deleteExam
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Exam deleted

  /admin/exams/{id}/questions:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    post:
      tags: [Exams]
      summary: Attach questions to exam
      operationId: attachQuestions
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                questionIds:
                  type: array
                  items:
                    type: integer
                  minItems: 1
                  maxItems: 200
              required: [questionIds]
      responses:
        "200":
          description: Questions attached
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/AttachQuestionsResponse"
    get:
      tags: [Exams]
      summary: Get exam questions (admin)
      operationId: getExamQuestions
      security:
        - bearerAuth: []
      parameters:
        - name: type
          in: query
          schema:
            $ref: "#/components/schemas/QuestionType"
      responses:
        "200":
          description: Exam questions with correct answers
    delete:
      tags: [Exams]
      summary: Detach questions from exam
      operationId: detachQuestions
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                questionIds:
                  type: array
                  items:
                    type: integer
              required: [questionIds]
      responses:
        "200":
          description: Questions detached
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/DetachQuestionsResponse"

  # === EXAM SESSIONS ENDPOINTS ===
  /exam-sessions:
    get:
      tags: [Exam Sessions]
      summary: Get my exam sessions
      description: Get all exam sessions (attempts) for the current user
      operationId: getUserExams
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/pageParam"
        - $ref: "#/components/parameters/limitParam"
      responses:
        "200":
          description: Exam sessions list with attempt information
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          data:
                            type: array
                            items:
                              $ref: "#/components/schemas/UserExamListItem"
                          pagination:
                            $ref: "#/components/schemas/PaginationMeta"

  /exam-sessions/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Exam Sessions]
      summary: Get exam session details
      operationId: getUserExam
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Session details with attemptNumber

  /exam-sessions/{id}/questions:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Exam Sessions]
      summary: Get questions for active exam
      operationId: getExamSessionQuestions
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Questions without correct answers

  /exam-sessions/{id}/answers:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    post:
      tags: [Exam Sessions]
      summary: Submit/update answer (auto-save)
      operationId: submitAnswer
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                examQuestionId:
                  type: integer
                  description: ExamQuestion ID, NOT question bank ID!
                selectedOption:
                  $ref: "#/components/schemas/AnswerOption"
              required: [examQuestionId]
      responses:
        "200":
          description: Answer saved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          answer:
                            type: object
                            properties:
                              examQuestionId:
                                type: integer
                              selectedOption:
                                $ref: "#/components/schemas/AnswerOption"
                              answeredAt:
                                type: string
                                format: date-time
                          progress:
                            type: object
                            properties:
                              answered:
                                type: integer
                              total:
                                type: integer
                              percentage:
                                type: number
    get:
      tags: [Exam Sessions]
      summary: Get answers for review (after submit)
      operationId: getExamAnswers
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Answers with correct answers (only available after submission)

  /exam-sessions/{id}/submit:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
    post:
      tags: [Exam Sessions]
      summary: Submit and finalize exam
      operationId: submitExam
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Exam submitted
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          message:
                            type: string
                          result:
                            $ref: "#/components/schemas/ExamResult"

  /results:
    get:
      tags: [Exam Sessions]
      summary: Get my exam results
      description: Get results for all exam attempts
      operationId: getMyResults
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/pageParam"
        - $ref: "#/components/parameters/limitParam"
      responses:
        "200":
          description: Results list (includes attemptNumber for each result)

  /admin/exam-sessions:
    get:
      tags: [Exam Sessions]
      summary: Get all exam sessions (admin)
      operationId: getResults
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/pageParam"
        - $ref: "#/components/parameters/limitParam"
        - name: examId
          in: query
          schema:
            type: integer
        - name: userId
          in: query
          schema:
            type: integer
        - name: status
          in: query
          schema:
            $ref: "#/components/schemas/ExamStatus"
      responses:
        "200":
          description: All sessions with attemptNumber

  /admin/exam-sessions/{id}:
    get:
      tags: [Exam Sessions]
      summary: Get specific exam session (admin)
      description: Retrieve details of any exam session. Admin access only.
      operationId: getAdminExamSessionById
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: UserExam session ID
          schema:
            type: integer
      responses:
        "200":
          description: Session details including attemptNumber
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                      examId:
                        type: integer
                      userId:
                        type: integer
                      status:
                        $ref: "#/components/schemas/ExamStatus"
                      startedAt:
                        type: string
                        format: date-time
                      submittedAt:
                        type: string
                        format: date-time
                        nullable: true
                      totalScore:
                        type: integer
                        nullable: true
                      attemptNumber:
                        type: integer
                        minimum: 1
                      user:
                        type: object
                        properties:
                          id:
                            type: integer
                          name:
                            type: string
                          email:
                            type: string
                      exam:
                        type: object
                        properties:
                          id:
                            type: integer
                          title:
                            type: string
                  message:
                    type: string
                  timestamp:
                    type: string
                    format: date-time
        "404":
          description: Session not found

  /admin/exam-sessions/{id}/answers:
    get:
      tags: [Exam Sessions]
      summary: Get answers for any exam session (admin)
      description: Retrieve all answers with review data for any session. Admin access only.
      operationId: getAdminExamSessionAnswers
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: UserExam session ID
          schema:
            type: integer
      responses:
        "200":
          description: All answers with correct answer visibility
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      answers:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: integer
                            examQuestionId:
                              type: integer
                            selectedOption:
                              $ref: "#/components/schemas/AnswerOption"
                            isCorrect:
                              type: boolean
                            answeredAt:
                              type: string
                              format: date-time
                              nullable: true
                            examQuestion:
                              type: object
                              properties:
                                orderNumber:
                                  type: integer
                                question:
                                  $ref: "#/components/schemas/Question"
                      total:
                        type: integer
                  message:
                    type: string
                  timestamp:
                    type: string
                    format: date-time
        "404":
          description: Session not found

  /admin/results:
    get:
      tags: [Exam Sessions]
      summary: Get all results (admin)
      operationId: getAllResults
      security:
        - bearerAuth: []
      responses:
        "200":
          description: All results

  # === PROCTORING ENDPOINTS ===
  /proctoring/events:
    post:
      tags: [Proctoring]
      summary: Log proctoring event
      operationId: logEvent
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userExamId:
                  type: integer
                eventType:
                  $ref: "#/components/schemas/ProctoringEventType"
                metadata:
                  type: object
              required: [userExamId, eventType]
      responses:
        "200":
          description: Event logged

  /proctoring/exam-sessions/{userExamId}/analyze-face:
    parameters:
      - name: userExamId
        in: path
        required: true
        schema:
          type: integer
    post:
      tags: [Proctoring]
      summary: Analyze face via YOLO ML
      description: |
        **⚠️ CRITICAL: This is the ML integration endpoint for thesis demonstration!**

        Analyzes webcam frame using YOLO face detection.
        Rate limited to 30 requests/minute.
      operationId: analyzeFace
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                imageBase64:
                  type: string
                  minLength: 100
                  description: Base64 encoded image
              required: [imageBase64]
      responses:
        "200":
          description: Analysis complete
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ApiSuccessResponse"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          analysis:
                            $ref: "#/components/schemas/FaceAnalysisResult"
                          eventLogged:
                            type: boolean
                          eventType:
                            $ref: "#/components/schemas/ProctoringEventType"
                            nullable: true
                          usedFallback:
                            type: boolean

  /proctoring/exam-sessions/{userExamId}/events:
    parameters:
      - name: userExamId
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Proctoring]
      summary: Get proctoring events for session
      operationId: getEvents
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/pageParam"
        - $ref: "#/components/parameters/limitParam"
        - name: eventType
          in: query
          schema:
            $ref: "#/components/schemas/ProctoringEventType"
        - name: startDate
          in: query
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          schema:
            type: string
            format: date-time
        - $ref: "#/components/parameters/sortOrderParam"
      responses:
        "200":
          description: Proctoring events

  /admin/proctoring/events:
    get:
      tags: [Proctoring]
      summary: Get all proctoring events (admin)
      description: Get all proctoring events with attempt information
      operationId: getAdminEvents
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/pageParam"
        - $ref: "#/components/parameters/limitParam"
        - name: eventType
          in: query
          schema:
            $ref: "#/components/schemas/ProctoringEventType"
        - name: userExamId
          in: query
          schema:
            type: integer
        - name: startDate
          in: query
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          schema:
            type: string
            format: date-time
        - $ref: "#/components/parameters/sortOrderParam"
      responses:
        "200":
          description: All proctoring events (includes attemptNumber in userExam)

  /admin/proctoring/exam-sessions/{userExamId}/events:
    parameters:
      - name: userExamId
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Proctoring]
      summary: Get proctoring events for any session (admin)
      operationId: getAdminSessionEvents
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Session proctoring events
